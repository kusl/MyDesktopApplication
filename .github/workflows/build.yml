name: Build

on:
  push:
    branches: [master, main, develop]

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  APP_NAME: MyDesktopApplication

jobs:
  # ==========================================================================
  # Get version info
  # ==========================================================================
  version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Generate version
        id: version
        run: |
          # Pre-release version based on date and run number
          VERSION="0.0.0-dev.$(date +'%Y%m%d').${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

  # ==========================================================================
  # Build Desktop - Each platform uploads its own artifact
  # ==========================================================================
  build-windows-x64:
    name: Windows x64
    needs: version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj `
            -c Release -r win-x64 --self-contained true -o ./publish `
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true `
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: Compress-Archive -Path ./publish/* -DestinationPath ./${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-win-x64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-win-x64
          path: ./*.zip
          retention-days: 30

  build-windows-arm64:
    name: Windows ARM64
    needs: version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj `
            -c Release -r win-arm64 --self-contained true -o ./publish `
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true `
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: Compress-Archive -Path ./publish/* -DestinationPath ./${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-win-arm64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-win-arm64
          path: ./*.zip
          retention-days: 30

  build-linux-x64:
    name: Linux x64
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj \
            -c Release -r linux-x64 --self-contained true -o ./publish \
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true \
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: tar -czvf ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-linux-x64.tar.gz -C ./publish .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: ./*.tar.gz
          retention-days: 30

  build-linux-arm64:
    name: Linux ARM64
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj \
            -c Release -r linux-arm64 --self-contained true -o ./publish \
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true \
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: tar -czvf ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-linux-arm64.tar.gz -C ./publish .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-arm64
          path: ./*.tar.gz
          retention-days: 30

  build-macos-x64:
    name: macOS x64
    needs: version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj \
            -c Release -r osx-x64 --self-contained true -o ./publish \
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true \
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: tar -czvf ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-osx-x64.tar.gz -C ./publish .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-osx-x64
          path: ./*.tar.gz
          retention-days: 30

  build-macos-arm64:
    name: macOS ARM64
    needs: version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Desktop/MyDesktopApplication.Desktop.csproj \
            -c Release -r osx-arm64 --self-contained true -o ./publish \
            -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true \
            -p:Version=${{ needs.version.outputs.version }}
      - name: Archive
        run: tar -czvf ${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-osx-arm64.tar.gz -C ./publish .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-osx-arm64
          path: ./*.tar.gz
          retention-days: 30

  build-android:
    name: Android
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Install Android workload
        run: dotnet workload install android
      - name: Publish
        run: |
          dotnet publish src/MyDesktopApplication.Android/MyDesktopApplication.Android.csproj \
            -c Release -f net10.0-android -o ./publish \
            -p:Version=${{ needs.version.outputs.version }} \
            -p:AndroidPackageFormat=apk
      - name: Find and rename APK
        run: |
          APK=$(find ./publish -name "*.apk" | head -1)
          if [ -n "$APK" ]; then
            cp "$APK" ./${{ env.APP_NAME }}-${{ needs.version.outputs.version }}-android.apk
          fi
          ls -la ./*.apk || echo "No APK found"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android
          path: ./*.apk
          retention-days: 30
          if-no-files-found: warn

  # ==========================================================================
  # Create Pre-release with all artifacts
  # ==========================================================================
  prerelease:
    name: Create Pre-release
    needs: [version, build-windows-x64, build-windows-arm64, build-linux-x64, build-linux-arm64, build-macos-x64, build-macos-arm64, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      # Download each artifact separately
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-win-x64
          path: ./artifacts/win-x64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-win-arm64
          path: ./artifacts/win-arm64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: ./artifacts/linux-x64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-arm64
          path: ./artifacts/linux-arm64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-osx-x64
          path: ./artifacts/osx-x64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-osx-arm64
          path: ./artifacts/osx-arm64
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android
          path: ./artifacts/android
        continue-on-error: true

      - name: List artifacts
        run: find ./artifacts -type f | sort

      - name: Delete previous dev release
        run: |
          gh release delete dev --yes || true
          git push origin :refs/tags/dev || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          name: "Development Build (${{ needs.version.outputs.version }})"
          prerelease: true
          draft: false
          body: |
            ## Development Build
            
            **Version:** ${{ needs.version.outputs.version }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            This is an automated pre-release build. For stable releases, see tagged versions.
          files: |
            ./artifacts/**/*.zip
            ./artifacts/**/*.tar.gz
            ./artifacts/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
